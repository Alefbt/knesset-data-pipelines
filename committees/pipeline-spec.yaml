committees:
  schedule:
    crontab: "0 0 * * *"
  pipeline:
    - run: add_metadata
      parameters:
        name: committees
    - run: ..datapackage_pipelines_knesset.dataservice.processors.add_dataservice_collection_resource
      parameters:
        resource-name: committees
        service-name: committees
        method-name: "View_committee"
        fields:
          id:
            source: committee_id
            type: integer
            description: the primary key
          type_id:
            source: committee_type_id
            type: integer
            description: linked to committee types dataservice
          parent_id:
            source: committee_parent_id
            type: integer
            description: used for sub-committees, not sure if reliable
          name:
            source: committee_name
            type: string
            description: hebrew name
          name_eng:
            source: committee_name_eng
            type: string
          name_arb:
            source: committee_name_arb
            type: string
          begin_date:
            source: committee_begin_date
            type: date
          end_date:
            source: committee_end_date
            type: datetime
            description: we assume empty end_date means committee is active in current Knesset
          description:
            source: committee_desc
            type: string
            description: hebrew description
          description_eng:
            source: committee_desc_eng
            type: string
          description_arb:
            source: committee_desc_arb
            type: string
          note:
            source: committee_note
            type: string
          note_eng:
            source: committee_note_eng
            type: string
          portal_link:
            source: committee_portal_link
            type: string
            description: can be used to link to the dedicated page in knesset website
    - run: dump.to_path
      parameters:
        out-path: ../data/committees

committees-update-db:
  dependencies:
    - pipeline: ./committees/committees
  pipeline:
    - run: load_resource
      parameters:
        resource: committees
        url: ../data/committees/datapackage.json
    - run: dump.to_sql
      parameters:
        tables:
          committees:
            resource-name: committees
            mode: update

committee-meetings:
  dependencies:
    - pipeline: ./committees/committees-update-db
  pipeline:
    - run: add_metadata
      parameters:
        name: committee-meetings
    - run: ..datapackage_pipelines_knesset.common.processors.add_sql_resource
      parameters:
        datapackage: ../data/committees/datapackage.json
        resource: committees
        table: committees
    - run: stream_remote_resources
    - run: ..datapackage_pipelines_knesset.dataservice.processors.dataservice_function_resource
      parameters:
        input-resource: committees
        output-resource: committee-meetings
        base-url: http://online.knesset.gov.il/WsinternetSps/KnessetDataService/CommitteeScheduleData.svc/CommitteeAgendaSearch
        # these are the dataservice function parameters
        parameters:
          CommitteeId:
            source: input-resource
            field: id
            override-values-env: OVERRIDE_COMMITTEE_IDS
          FromDate:
            source: current-date
            timedelta:
              - unit: days
                value: -120
          ToDate:
            source: current-date
        parameter-retries:
          - FromDate:
              timedelta-value: -60
          - FromDate:
              timedelta-value: -30
          - FromDate:
              timedelta-value: -15
          - FromDate:
              timedelta-value: -1
        # mapping between the dataservice fields and the datapackage fields
        fields:
          id:
            source: Committee_Agenda_id
            type: integer
            description: the primary key of committee meetings
          committee_id:
            source: Committee_Agenda_committee_id
            type: integer
            description: id of the committee (linked to Committee object)
          datetime:
            source: committee_agenda_date
            type: datetime
            description: date/time when the meeting started
          title:
            source: title
            type: string
            description: title of the meeting
          session_content:
            source: committee_agenda_session_content
            type: string
            description: seems like in some committee meetings, the title field is empty, in that case title can be taken from this field
          url:
            source: url
            type: string
            description: url to download the protocol
          # a CommitteeMeetingProtocol object which allows to get data from the protocol
          # because parsing the protocol requires heavy IO and processing - we provide it as a generator
          # see tests/test_meetings.py for usage example
#          protocol:
#            source: KnessetDataServiceLambdaField(lambda obj, entry: CommitteeMeetingProtocol.get_from_url(obj.url, proxies=obj._proxies) if obj.url else None))
          location:
            source: committee_location
            type: string
            description: this seems like a shorter name of the place where meeting took place
          place:
            source: Committee_Agenda_place
            type: string
            description: this looks like a longer field with the specific details of where the meeting took place
          meeting_stop:
            source: meeting_stop
            type: string
            description: date/time when the meeting ended - this is not always available, in some meetings it's empty
          ### following fields seem less interesting ###
          agenda_canceled:
            source: Committee_Agenda_canceled
            type: string
          agenda_sub:
            source: Committee_agenda_sub
            type: string
          agenda_associated:
            source: Committee_agenda_associated
            type: string
          agenda_associated_id:
            source: Committee_agenda_associated_id
            type: string
          agenda_special:
            source: Committee_agenda_special
            type: string
          agenda_invited1:
            source: Committee_agenda_invited1
            type: string
          agenda_invite:
            source: sd2committee_agenda_invite
            type: boolean
          note:
            source: Committee_agenda_note
            type: string
          start_datetime:
            source: StartDateTime
            type: datetime
          topic_id:
            source: Topic_ID
            type: integer
          creation_date:
            source: Date_Creation
            type: datetime
          streaming_url:
            source: streaming_url
            type: string
          meeting_start:
            source: meeting_start
            type: string
          is_paused:
            source: meeting_is_paused
            type: boolean
          date_order:
            source: committee_date_order
            type: string
          date:
            source: committee_date
            type: string
          day:
            source: committee_day
            type: string
          month:
            source: committee_month
            type: string
          material_id:
            source: material_id
            type: string
          material_committee_id:
            source: material_comittee_id
            type: string
          material_expiration_date:
            source: material_expiration_date
            type: string
          material_hour:
            source: committee_material_hour
            type: string
          old_url:
            source: OldUrl
            type: string
          background_page_link:
            source: CommitteeBackgroundPageLink
            type: string
          agenda_invited:
            source: Committee_agenda_invited
            type: string
          protocol_text:
            type: string
    - run: dump.to_path
      parameters:
        out-path: ../data/committee-meetings

committee-meetings-update-db:
  dependencies:
    - pipeline: ./committees/committee-meetings
  pipeline:
    - run: load_resource
      parameters:
        resource: committee-meetings
        url: ../data/committee-meetings/datapackage.json
    - run: dump.to_sql
      parameters:
        tables:
          committee-meetings:
            resource-name: committee-meetings
            mode: update

committee-meeting-protocols:
  dependencies:
    - pipeline: ./committees/committee-meetings-update-db
  pipeline:
    - run: add_metadata
      parameters:
        name: committee-meeting-protocols
    - run: ..datapackage_pipelines_knesset.common.processors.add_sql_resource
      parameters:
        datapackage: ../data/committee-meetings/datapackage.json
        resource: committee-meetings
        table: committee-meetings
    - run: stream_remote_resources
    # only downloads protocols for meetings which don't have protocol_text value in DB
    - run: ..datapackage_pipelines_knesset.committees.processors.download_committee_meeting_protocols
      parameters:
        input-resource: committee-meetings
        output-resource: committee-meeting-protocols
        meetings-table: committee-meetings
        out-path: ../data/committee-meeting-protocols
    - run: dump.to_path
      parameters:
        out-path: ../data/committee-meeting-protocols

committee-meeting-protocols-parse:
  dependencies:
    - pipeline: ./committees/committee-meeting-protocols
  pipeline:
    - run: add_metadata
      parameters:
        name: committee-meeting-protocols-parse
    - run: load_resource
      parameters:
        resource: committee-meeting-protocols
        url: ../data/committee-meeting-protocols/datapackage.json
    # parse the downloaded protocol into text and parts files which will be saved in out-path
    - run: ..datapackage_pipelines_knesset.committees.processors.parse_committee_meeting_protocols
      parameters:
        input-resource: committee-meeting-protocols
        output-resource: committee-meeting-protocols-parsed
        out-path: ../data/committee-meeting-protocols-parsed
    # saves the protocol_text in meetings-table
    # deletes all protocol parts for each meeting (because they will be appended in next pipeline)
    # emits protocol_parts resource
    - run: ..datapackage_pipelines_knesset.committees.processors.committee_meeting_protocols_update_db
      parameters:
        input-resource: committee-meeting-protocols-parsed
        output-resource: committee-meeting-protocol-parts
        meetings-table: committee-meetings
        protocol-parts-table: committee-meeting-protocol-parts
    # save the protocol_parts
    - run: dump.to_path
      parameters:
        out-path: ../data/committee-meeting-protocols-parsed

committee-meeting-protocol-parts-update-db:
  dependencies:
    - pipeline: ./committees/committee-meeting-protocols-parse
  pipeline:
    - run: add_metadata
      parameters:
        name: committee-meeting-protocol-parts-update-db
    - run: load_resource
      parameters:
        resource: committee-meeting-protocol-parts
        url: ../data/committee-meeting-protocols-parsed/datapackage.json
    - run: dump.to_sql
      parameters:
        tables:
          committee-meeting-protocol-parts:
            resource-name: committee-meeting-protocol-parts
            mode: append
